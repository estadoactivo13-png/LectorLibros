<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader Pro | Andres Urrea</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #22c55e; }
        
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; min-height: 100vh; display: flex; flex-direction: column; 
        }

        header { 
            background: var(--card); padding: 20px; text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-bottom: 2px solid var(--primary);
        }

        .controls { 
            display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap; 
        }

        input[type="text"] { 
            padding: 12px; border-radius: 8px; border: 1px solid #334155; 
            background: #0f172a; color: white; width: 300px; outline: none;
        }

        button { 
            padding: 12px 20px; border-radius: 8px; border: none; 
            background: var(--primary); color: white; font-weight: 600; 
            cursor: pointer; transition: 0.3s;
        }

        button:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-upload { background: #475569; }

        .library { 
            max-width: 900px; margin: 20px auto; padding: 20px; 
            background: var(--card); border-radius: 12px; width: 90%;
        }

        .book-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid #334155; 
        }

        #viewer-container { 
            flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; 
        }

        /* Estilos espec√≠ficos para PDF y EPUB */
        #pdf-area { width: 100%; max-width: 850px; background: white; display: none; border-radius: 8px; overflow: hidden; }
        #epub-area { width: 100%; max-width: 800px; height: 70vh; background: white; display: none; border-radius: 8px; }
        canvas { width: 100%; height: auto; }

        .nav-bar { 
            background: var(--card); padding: 10px 30px; border-radius: 50px; 
            display: none; align-items: center; gap: 20px; margin-bottom: 20px;
            border: 1px solid var(--primary); position: sticky; top: 10px; z-index: 10;
        }

        footer { 
            background: var(--card); padding: 20px; text-align: center; 
            border-top: 1px solid #334155; font-size: 0.9rem;
        }

        footer a { color: var(--accent); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0">üìö Reader<span style="color:var(--primary)">Pro</span></h2>
    <div class="controls">
        <input type="text" id="url-input" placeholder="Pega enlace de Drive, PDF o EPUB...">
        <button onclick="handleUrl()">Cargar Enlace</button>
        <input type="file" id="file-in" accept=".pdf,.epub" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('file-in').click()">üìÅ Subir Archivo</button>
    </div>
    <div id="status" style="margin-top:10px; font-size: 0.8rem; color: #94a3b8;">Sistema Listo</div>
</header>

<div class="library">
    <h3 style="margin-top:0">üìñ Mi Biblioteca</h3>
    <div id="book-list"><em>No hay libros guardados en este navegador.</em></div>
</div>

<main id="viewer-container">
    <div class="nav-bar" id="nav-bar">
        <button onclick="prevPage()">‚óÄ Ant.</button>
        <span id="page-info">Cargando...</span>
        <button onclick="nextPage()">Sig. ‚ñ∂</button>
    </div>

    <div id="pdf-area"><canvas id="pdf-canvas"></canvas></div>
    <div id="epub-area"></div>
</main>

<footer>
    <p>Desarrollada por <strong>Andres Urrea</strong> como proyecto personal</p>
    <p>Contacto: <a href="https://wa.me/5693076322" target="_blank">üì≤ +5693076322</a></p>
</footer>

<script>
    // Configuraci√≥n Inicial
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let db, currentBook = null, rendition = null, pdfDoc = null, pageNum = 1, currentId = "";

    // Base de Datos IndexedDB
    const reqDB = indexedDB.open("ReaderAU_Storage", 1);
    reqDB.onupgradeneeded = e => e.target.result.createObjectStore("books", { keyPath: "id" });
    reqDB.onsuccess = e => { db = e.target.result; loadLibrary(); };

    // L√≥gica para Enlaces (Drive / Web)
    function cleanUrl(url) {
        if (url.includes('drive.google.com')) {
            const id = url.match(/[-\w]{25,}/);
            return id ? `https://docs.google.com/uc?export=download&id=${id[0]}` : url;
        }
        // Proxy para evitar bloqueo CORS
        return `https://corsproxy.io/?${encodeURIComponent(url.trim())}`;
    }

    async function handleUrl() {
        const url = document.getElementById('url-input').value;
        if(!url) return;
        const type = url.toLowerCase().includes('.epub') ? 'epub' : 'pdf';
        openBook(cleanUrl(url), url, type);
    }

    // L√≥gica para Archivos Locales
    document.getElementById('file-in').addEventListener('change', e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function() {
            const type = file.name.endsWith('.epub') ? 'epub' : 'pdf';
            const data = { id: file.name, name: file.name, content: this.result, type: type };
            const tx = db.transaction("books", "readwrite");
            tx.objectStore("books").put(data);
            tx.oncomplete = () => { loadLibrary(); openBook(this.result, file.name, type); };
        };
        reader.readAsArrayBuffer(file);
    });

    // Motor de Apertura
    async function openBook(source, id, type) {
        currentId = id;
        document.getElementById('status').textContent = "Cargando libro...";
        document.getElementById('nav-bar').style.display = 'flex';
        document.getElementById('pdf-area').style.display = 'none';
        document.getElementById('epub-area').style.display = 'none';

        if(type === 'pdf') {
            try {
                pdfDoc = await pdfjs.getDocument(source).promise;
                document.getElementById('pdf-area').style.display = 'block';
                const saved = localStorage.getItem('pos_' + id);
                pageNum = saved ? parseInt(saved) : 1;
                renderPDF(pageNum);
            } catch(e) { alert("Error al cargar PDF externo."); }
        } else {
            document.getElementById('epub-area').style.display = 'block';
            document.getElementById('epub-area').innerHTML = "";
            const book = ePub(source);
            rendition = book.renderTo("epub-area", { width: "100%", height: "100%", flow: "scrolled-doc" });
            const saved = localStorage.getItem('pos_' + id);
            rendition.display(saved || undefined);
            rendition.on("relocated", loc => {
                localStorage.setItem('pos_' + id, loc.start.cfi);
                document.getElementById('page-info').textContent = "EPUB: Progreso Guardado";
            });
        }
    }

    async function renderPDF(num) {
        const page = await pdfDoc.getPage(num);
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const vp = page.getViewport({ scale: 1.5 });
        canvas.height = vp.height; canvas.width = vp.width;
        await page.render({ canvasContext: ctx, viewport: vp }).promise;
        document.getElementById('page-info').textContent = `P√°gina ${num} de ${pdfDoc.numPages}`;
        localStorage.setItem('pos_' + currentId, num);
    }

    function prevPage() {
        if(pdfDoc && pageNum > 1) renderPDF(--pageNum);
        else if(rendition) rendition.prev();
    }

    function nextPage() {
        if(pdfDoc && pageNum < pdfDoc.numPages) renderPDF(++pageNum);
        else if(rendition) rendition.next();
    }

    function loadLibrary() {
        const list = document.getElementById('book-list');
        const tx = db.transaction("books", "readonly");
        tx.objectStore("books").getAll().onsuccess = e => {
            const books = e.target.result;
            if(books.length > 0) list.innerHTML = "";
            books.forEach(b => {
                const item = document.createElement('div');
                item.className = 'book-item';
                item.innerHTML = `<span>${b.type === 'pdf' ? 'üìï' : 'üìò'} ${b.name}</span> 
                <button onclick="loadFromDB('${b.id}')">Abrir</button>`;
                list.appendChild(item);
            });
        };
    }

    function loadFromDB(id) {
        db.transaction("books").objectStore("books").get(id).onsuccess = e => {
            const b = e.target.result;
            openBook(b.content, b.id, b.type);
        };
    }
</script>
</body>
</html>