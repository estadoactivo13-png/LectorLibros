<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reader Cloud | Andres Urrea</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        :root { --p: #6366f1; --bg: #0f172a; --c: #1e293b; --t: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--t); margin: 0; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .card { background: var(--c); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input { display: block; width: 250px; padding: 10px; margin: 10px 0; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { width: 100%; padding: 10px; background: var(--p); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #main-app { display: none; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .book-card { background: var(--c); padding: 15px; border-radius: 8px; border: 1px solid var(--p); text-align: center; }
        #viewer { width: 100%; height: 80vh; background: white; margin-top: 20px; display: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card">
            <h2>üîê Reader Cloud</h2>
            <input type="text" id="user" placeholder="Usuario (andres)">
            <input type="password" id="pass" placeholder="Contrase√±a (1234)">
            <button onclick="login()">Entrar</button>
        </div>
    </div>

    <div id="main-app">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üìö Mi Biblioteca Cloud</h2>
            <button onclick="location.reload()" style="width: auto;">Cerrar Sesi√≥n</button>
        </header>

        <div class="card">
            <h4>A√±adir nuevo libro (Archivo o Enlace)</h4>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="link-url" placeholder="Pegar enlace (Drive o Web)..." style="flex:1">
                <input type="file" id="file-in" style="display:none">
                <button onclick="document.getElementById('file-in').click()" style="width: auto;">üìÅ Subir</button>
                <button onclick="uploadFromLink()" style="width: auto;">üîó Cargar Link</button>
            </div>
        </div>

        <div id="library-grid" class="grid"></div>
        <div id="viewer"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzHfzJHQzSAeR1WfGFscxcwIa4pIFRPbugZTUQZFKT140XTy2vQouujrhAu1rARDZUDw/exec'; 
        let currentUser = "";

        async function login() {
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', user, pass })
            });
            const out = await res.json();
            if(out.success) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                loadLibrary();
            } else { alert("Error de acceso"); }
        }

        async function uploadFromLink() {
            const url = document.getElementById('link-url').value;
            if(!url) return;
            const name = url.split('/').pop().split('?')[0] || "Libro Enlazado";
            saveToCloud(name, url, "link", url.includes('.epub') ? 'epub' : 'pdf');
        }

        document.getElementById('file-in').onchange = function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function() {
                const base64 = reader.result.split(',')[1];
                saveToCloud(file.name, "", "file", file.name.endsWith('.epub') ? 'epub' : 'pdf', base64, file.type);
            };
            reader.readAsDataURL(file);
        };

        async function saveToCloud(name, url, mode, type, b64 = "", mime = "") {
            document.body.style.opacity = "0.5";
            await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'upload', user: currentUser, name, url, type,
                    fileData: b64, mimeType: mime
                })
            });
            location.reload();
        }

        async function loadLibrary() {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const grid = document.getElementById('library-grid');
            // Saltamos la cabecera del sheet
            data.slice(1).forEach(row => {
                if(row[5] === currentUser) {
                    const div = document.createElement('div');
                    div.className = 'book-card';
                    div.innerHTML = `<h3>${row[1]}</h3><p>${row[2]}</p><button onclick="openBook('${row[3]}','${row[2]}')">Leer</button>`;
                    grid.appendChild(div);
                }
            });
        }

        function openBook(url, type) {
            const v = document.getElementById('viewer');
            v.style.display = 'block';
            if(type === 'pdf') {
                v.innerHTML = `<iframe src="${url}" width="100%" height="100%"></iframe>`;
            } else {
                v.innerHTML = `<p style="color:black; padding: 20px;">Cargando lector EPUB...</p>`;
                // Aqu√≠ se integrar√≠a Epub.js como en los c√≥digos anteriores
            }
            v.scrollIntoView();
        }
    </script>
</body>
</html>
